# Data Model: Spring AI RAG with CSV Data Source

**Feature**: 002-spring-ai-csv-rag
**Date**: 2026-01-15

## Entities

### 1. Document (Spring AI Core)

Spring AI's built-in document representation for vector storage.

| Field | Type | Description | Constraints |
|-------|------|-------------|-------------|
| id | String | Unique identifier | Auto-generated UUID |
| content | String | Text content for embedding | Required, non-empty |
| metadata | Map<String, Object> | Key-value metadata | Optional |
| embedding | float[] | Vector representation | Generated by embedding model |

**Notes**: This is a Spring AI framework class, not a custom entity.

---

### 2. CsvDocumentMetadata

Metadata structure attached to documents created from CSV rows.

| Field | Type | Description | Source |
|-------|------|-------------|--------|
| source | String | CSV filename | System-assigned |
| rowNumber | Int | Original row number in CSV | Parser-assigned |
| headers | List<String> | Column names from CSV header | First row of CSV |
| timestamp | Instant | When document was created | System-assigned |

**Extension Point**: Add custom metadata fields based on your CSV schema.

---

### 3. RagConfiguration (Application Properties)

Configuration entity bound from `application.yml`.

| Property | Type | Description | Default |
|----------|------|-------------|---------|
| csvPath | String | Resource path to CSV file | `classpath:data/knowledge.csv` |
| chunkSize | Int | Max tokens per chunk | `500` |
| topK | Int | Number of results to retrieve | `5` |
| similarityThreshold | Double | Minimum similarity score | `0.7` |

---

## Relationships

```
┌─────────────────┐
│   CSV File      │
│  (resources/)   │
└────────┬────────┘
         │ parses
         ▼
┌─────────────────┐
│   CsvLoader     │
│   (Service)     │
└────────┬────────┘
         │ creates
         ▼
┌─────────────────┐      embeds      ┌─────────────────┐
│    Document     │ ───────────────► │  PGVector Store │
│  (Spring AI)    │                  │   (PostgreSQL)  │
└─────────────────┘                  └────────┬────────┘
                                              │
                                              │ queries
                                              ▼
                                     ┌─────────────────┐
                                     │   RagService    │
                                     │  (Retrieval)    │
                                     └─────────────────┘
```

---

## State Transitions

### Document Lifecycle

```
[CSV Row] ──parse──► [Raw Record] ──format──► [Document] ──embed──► [Stored Vector]
```

### Application Startup Flow

```
[App Start] ──► [Load CSV] ──► [Parse Rows] ──► [Create Documents] ──► [Generate Embeddings] ──► [Store in PGVector] ──► [Ready]
```

---

## Validation Rules

| Entity | Field | Rule |
|--------|-------|------|
| Document | content | Non-null, non-blank |
| Document | metadata.source | Must reference valid CSV file |
| RagConfiguration | csvPath | Must be valid classpath or file resource |
| RagConfiguration | topK | Must be > 0 |
| RagConfiguration | similarityThreshold | Must be between 0.0 and 1.0 |

---

## Database Schema

### PGVector Table (Auto-created by Spring AI)

```sql
-- Created automatically with initialize-schema: true
CREATE TABLE IF NOT EXISTS vector_store (
    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
    content text,
    metadata json,
    embedding vector(1536)  -- Dimension matches embedding model
);

CREATE INDEX ON vector_store USING HNSW (embedding vector_cosine_ops);
```

**Note**: The `dimensions` value (1536) must match your embedding model:
- OpenAI `text-embedding-ada-002`: 1536
- Ollama `nomic-embed-text`: 768
- Ollama `mxbai-embed-large`: 1024

---

## Extension Points

### Custom Metadata (TODO)

```kotlin
// In CsvLoader - add your domain-specific metadata
metadata = mapOf(
    "source" to csvFileName,
    "rowNumber" to rowIndex,
    // TODO: Add fields from your CSV schema
    // "category" to record["category"],
    // "productId" to record["id"],
)
```

### Custom Content Formatting (TODO)

```kotlin
// In CsvLoader - format CSV row as searchable text
fun formatRowAsContent(record: Map<String, String>): String {
    // TODO: Implement based on your CSV structure
    // Example: "Product: ${record["name"]}. Description: ${record["description"]}"
    return record.values.joinToString(" | ")
}
```
